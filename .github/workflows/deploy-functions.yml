name: Deploy Azure Functions

on:
  push:
    branches:
      - main
    paths:
      - 'azure-functions/**'
  workflow_dispatch:

env:
  AZURE_FUNCTIONAPP_NAME: '' # Set this in repository secrets or update manually
  AZURE_FUNCTIONAPP_PACKAGE_PATH: 'azure-functions/ProcessCsvBlobTrigger'
  DOTNET_VERSION: '8.0.x'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}/ProcessCsvBlobTrigger.csproj
        continue-on-error: false

      - name: Build
        run: dotnet build ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}/ProcessCsvBlobTrigger.csproj --configuration Release --no-restore
        continue-on-error: false

      - name: Publish
        run: dotnet publish ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}/ProcessCsvBlobTrigger.csproj --configuration Release --output ./publish --no-build
        continue-on-error: false

      - name: Verify publish output
        run: |
          echo "Checking publish output structure..."
          ls -la ./publish/
          echo ""
          echo "Checking for required files..."
          test -f ./publish/ProcessCsvBlobTrigger.dll && echo "✓ ProcessCsvBlobTrigger.dll found" || echo "✗ ProcessCsvBlobTrigger.dll missing"
          test -f ./publish/host.json && echo "✓ host.json found" || echo "✗ host.json missing"
          test -f ./publish/worker.config.json && echo "✓ worker.config.json found" || echo "✗ worker.config.json missing"
          test -f ./publish/functions.metadata && echo "✓ functions.metadata found" || echo "✗ functions.metadata missing"
        continue-on-error: false

      - name: Create deployment package
        run: cd publish && zip -r ../function-app.zip . && cd ..
        continue-on-error: false
      
      - name: Verify ZIP package
        run: |
          echo "ZIP package size:"
          ls -lh function-app.zip
          echo ""
          echo "ZIP package contents:"
          unzip -l function-app.zip | head -20
        continue-on-error: false

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Azure Functions (Run from Package)
        run: |
          echo "Deploying ZIP package..."
          az functionapp deployment source config-zip \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --name ${{ secrets.AZURE_FUNCTIONAPP_NAME }} \
            --src function-app.zip \
            --timeout 600
          echo ""
          echo "Deployment completed. Azure automatically uploads the ZIP to Blob Storage"
          echo "and should set WEBSITE_RUN_FROM_PACKAGE to the blob URL."
        continue-on-error: false
      
      - name: Ensure WEBSITE_RUN_FROM_PACKAGE is set
        run: |
          echo "Checking if WEBSITE_RUN_FROM_PACKAGE is set..."
          PACKAGE_URL=$(az functionapp config appsettings list \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --name ${{ secrets.AZURE_FUNCTIONAPP_NAME }} \
            --query "[?name=='WEBSITE_RUN_FROM_PACKAGE'].value" \
            -o tsv)
          
          if [ -z "$PACKAGE_URL" ] || [ "$PACKAGE_URL" == "None" ]; then
            echo "⚠ WEBSITE_RUN_FROM_PACKAGE not set. Finding latest deployment package..."
            
            # Get storage account name from connection string
            STORAGE_CONNECTION=$(az functionapp config appsettings list \
              --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
              --name ${{ secrets.AZURE_FUNCTIONAPP_NAME }} \
              --query "[?name=='AzureWebJobsStorage'].value" \
              -o tsv)
            STORAGE_ACCOUNT=$(echo "$STORAGE_CONNECTION" | sed -n 's/.*AccountName=\([^;]*\).*/\1/p')
            
            # Get storage account key
            STORAGE_KEY=$(az storage account keys list \
              --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
              --account-name $STORAGE_ACCOUNT \
              --query "[0].value" \
              -o tsv)
            
            # Find latest package in function-releases container
            LATEST_PACKAGE=$(az storage blob list \
              --account-name $STORAGE_ACCOUNT \
              --container-name function-releases \
              --account-key $STORAGE_KEY \
              --query "sort_by(@, &properties.lastModified)[-1].name" \
              -o tsv)
            
            if [ -n "$LATEST_PACKAGE" ]; then
              # Generate SAS token (valid for 10 years)
              EXPIRY=$(date -u -d "+10 years" +"%Y-%m-%dT%H:%M:%SZ")
              SAS_TOKEN=$(az storage container generate-sas \
                --name function-releases \
                --account-name $STORAGE_ACCOUNT \
                --account-key $STORAGE_KEY \
                --permissions r \
                --expiry $EXPIRY \
                -o tsv)
              
              PACKAGE_URL="https://${STORAGE_ACCOUNT}.blob.core.windows.net/function-releases/${LATEST_PACKAGE}?${SAS_TOKEN}"
              
              echo "Setting WEBSITE_RUN_FROM_PACKAGE to: $PACKAGE_URL"
              az functionapp config appsettings set \
                --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
                --name ${{ secrets.AZURE_FUNCTIONAPP_NAME }} \
                --settings WEBSITE_RUN_FROM_PACKAGE="$PACKAGE_URL" \
                --output none
              
              echo "✅ WEBSITE_RUN_FROM_PACKAGE set successfully"
            else
              echo "⚠ Could not find deployment package. Azure should set this automatically."
            fi
          else
            echo "✅ WEBSITE_RUN_FROM_PACKAGE is already set: ${PACKAGE_URL:0:80}..."
          fi
        continue-on-error: false
      
      - name: Sync Function Triggers
        run: |
          echo "Synchronizing function triggers (required for Linux Consumption Plan)..."
          az functionapp function keys list \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --name ${{ secrets.AZURE_FUNCTIONAPP_NAME }} \
            --output none || true
          # Force trigger sync by restarting
          echo "Restarting Function App to sync triggers..."
          az functionapp restart \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --name ${{ secrets.AZURE_FUNCTIONAPP_NAME }}
          echo "Waiting for Function App to be ready..."
          sleep 20
        continue-on-error: false
      
      - name: Verify deployment
        run: |
          echo "✅ Deployment completed successfully!"
          echo "Function App: ${{ secrets.AZURE_FUNCTIONAPP_NAME }}"
          echo "Resource Group: ${{ secrets.AZURE_RESOURCE_GROUP }}"
          echo ""
          echo "Function App URL:"
          az functionapp show \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --name ${{ secrets.AZURE_FUNCTIONAPP_NAME }} \
            --query defaultHostName \
            --output tsv
          echo ""
          echo "Checking Function App status..."
          az functionapp show \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --name ${{ secrets.AZURE_FUNCTIONAPP_NAME }} \
            --query "{state: state, hostNames: defaultHostName}" \
            --output table
          echo ""
          echo "Checking WEBSITE_RUN_FROM_PACKAGE setting..."
          az functionapp config appsettings list \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --name ${{ secrets.AZURE_FUNCTIONAPP_NAME }} \
            --query "[?name=='WEBSITE_RUN_FROM_PACKAGE'].{Name: name, Value: value}" \
            --output table

      # Note: Required GitHub secrets:
      # 1. AZURE_CREDENTIALS: Service Principal credentials (JSON format)
      #    Create with: az ad sp create-for-rbac --name "github-actions" --role contributor --scopes /subscriptions/{subscription-id}/resourceGroups/{resource-group} --sdk-auth
      # 2. AZURE_RESOURCE_GROUP: Resource group name (e.g., "rg-infrastructure-as-code")
      # 3. AZURE_FUNCTIONAPP_NAME: Function app name (get from terraform output function_app_name)
      #
      # This workflow uses "Run from Package" mode (WEBSITE_RUN_FROM_PACKAGE=1),
      # which is Microsoft's recommended deployment method for Azure Functions.

