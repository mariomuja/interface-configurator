name: Deploy Azure Functions

on:
  push:
    branches:
      - main
    paths:
      - 'azure-functions/**'
      - '.github/workflows/deploy-azure-functions.yml'
  workflow_dispatch:

env:
  AZURE_FUNCTIONAPP_NAME: func-appe1mz5h  # Will be updated from Terraform outputs
  AZURE_FUNCTIONAPP_PACKAGE_PATH: 'azure-functions/ProcessCsvBlobTrigger'
  DOTNET_VERSION: '8.0.x'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout GitHub Action'
        uses: actions/checkout@v4

      - name: Setup .NET Core
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: 'Resolve Project Dependencies'
        shell: bash
        run: |
          cd './${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}'
          pwd
          ls -la
          echo "Restoring dependencies..."
          dotnet restore ProcessCsvBlobTrigger.csproj

      - name: 'Build .NET Function App'
        shell: bash
        run: |
          cd './${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}'
          echo "Building project..."
          dotnet build ProcessCsvBlobTrigger.csproj --configuration Release --no-restore

      - name: 'Publish .NET Function App'
        shell: bash
        run: |
          cd './${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}'
          echo "Publishing project..."
          dotnet publish ProcessCsvBlobTrigger.csproj --configuration Release --output ./publish --no-build

      - name: 'Create deployment package'
        shell: bash
        run: |
          cd './${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}/publish'
          # Verify required files exist
          echo "Checking required files..."
          ls -la host.json || echo "ERROR: host.json not found!"
          ls -la functions.metadata || echo "ERROR: functions.metadata not found!"
          ls -la ProcessCsvBlobTrigger.dll || echo "ERROR: ProcessCsvBlobTrigger.dll not found!"
          ls -la ProcessCsvBlobTrigger.Core.dll || echo "WARNING: ProcessCsvBlobTrigger.Core.dll not found (might be OK)"
          ls -la extensions.json || echo "WARNING: extensions.json not found"
          
          # Verify Core assembly is present
          if [ ! -f "ProcessCsvBlobTrigger.dll" ]; then
            echo "❌ ERROR: ProcessCsvBlobTrigger.dll is missing!"
            exit 1
          fi
          
          if [ ! -f "host.json" ]; then
            echo "❌ ERROR: host.json is missing!"
            exit 1
          fi
          
          if [ ! -f "functions.metadata" ]; then
            echo "❌ ERROR: functions.metadata is missing!"
            exit 1
          fi
          
          # Exclude unnecessary files to reduce package size
          echo "Cleaning up unnecessary files..."
          find . -name "Microsoft.CodeAnalysis*.dll" -delete || true
          find . -name "Microsoft.CodeAnalysis*.pdb" -delete || true
          find . -name "*.Designer.dll" -delete || true
          find . -name "*.Designer.pdb" -delete || true
          find . -name "*.xml" -delete || true
          find . -name "*.pdb" -delete || true
          find . -type d -name "runtimes" -exec rm -rf {} + 2>/dev/null || true
          
          # Create ZIP with all files (use absolute path to avoid issues)
          # Important: Create ZIP from current directory (publish folder) with all files
          ZIP_PATH="$(pwd)/../function-app.zip"
          echo "Creating ZIP from: $(pwd)"
          echo "ZIP will be created at: $ZIP_PATH"
          
          # List files before creating ZIP
          echo "Files to be included in ZIP:"
          find . -type f | head -20
          
          # Create ZIP - include all files from current directory
          zip -r "$ZIP_PATH" . -q
          cd ..
          
          echo "Package created at: $ZIP_PATH"
          echo "Package size: $(du -h function-app.zip | cut -f1)"
          echo ""
          echo "Package contents (first 50 files):"
          unzip -l function-app.zip | head -50
          
          # Verify ZIP contains critical files (check exact paths)
          echo ""
          echo "Verifying critical files in ZIP..."
          if unzip -l function-app.zip | grep -qE "(^|\s)host\.json(\s|$)"; then
            echo "✅ host.json found in ZIP"
          else
            echo "❌ ERROR: ZIP does not contain host.json!"
            echo "ZIP contents:"
            unzip -l function-app.zip | grep -i "host\|json" || true
            exit 1
          fi
          
          if unzip -l function-app.zip | grep -qE "(^|\s)functions\.metadata(\s|$)"; then
            echo "✅ functions.metadata found in ZIP"
          else
            echo "❌ ERROR: ZIP does not contain functions.metadata!"
            exit 1
          fi
          
          if unzip -l function-app.zip | grep -q "ProcessCsvBlobTrigger.dll"; then
            echo "✅ ProcessCsvBlobTrigger.dll found in ZIP"
          else
            echo "❌ ERROR: ZIP does not contain ProcessCsvBlobTrigger.dll!"
            echo "DLL files in ZIP:"
            unzip -l function-app.zip | grep "\.dll" | head -10 || true
            exit 1
          fi
          
          echo "✅ ZIP package verified successfully"

      - name: 'Azure Login'
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: 'Deploy to Azure Functions via Azure CLI'
        shell: bash
        run: |
          set -eo pipefail
          echo "Deploying ZIP package via Azure CLI..."
          
          ZIP_PATH="${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}/function-app.zip"
          
          # Verify ZIP file exists
          if [ ! -f "$ZIP_PATH" ]; then
            echo "❌ ERROR: ZIP file not found at $ZIP_PATH"
            exit 1
          fi
          
          echo "ZIP file size: $(du -h "$ZIP_PATH" | cut -f1)"
          echo "ZIP file absolute path: $(realpath "$ZIP_PATH")"
          
          # Verify ZIP file is valid
          echo "Verifying ZIP file integrity..."
          if ! unzip -t "$ZIP_PATH" > /dev/null 2>&1; then
            echo "❌ ERROR: ZIP file is corrupted or invalid!"
            exit 1
          fi
          echo "✅ ZIP file is valid"
          
          # List first few files in ZIP for debugging
          echo "First 30 files in ZIP:"
          unzip -l "$ZIP_PATH" | head -35
          
          # Check if critical files exist (with better pattern matching)
          echo ""
          echo "Checking for critical files..."
          ZIP_CONTENTS=$(unzip -l "$ZIP_PATH")
          
          if echo "$ZIP_CONTENTS" | grep -qE "(^|\s)host\.json(\s|$)"; then
            echo "✅ host.json found in ZIP"
          else
            echo "❌ ERROR: host.json not found in ZIP!"
            echo "Files containing 'host' or 'json':"
            echo "$ZIP_CONTENTS" | grep -i "host\|json" || echo "None found"
            exit 1
          fi
          
          if echo "$ZIP_CONTENTS" | grep -q "ProcessCsvBlobTrigger.dll"; then
            echo "✅ ProcessCsvBlobTrigger.dll found in ZIP"
          else
            echo "❌ ERROR: ProcessCsvBlobTrigger.dll not found in ZIP!"
            echo "DLL files in ZIP:"
            echo "$ZIP_CONTENTS" | grep "\.dll" | head -10 || echo "None found"
            exit 1
          fi
          
          if echo "$ZIP_CONTENTS" | grep -qE "(^|\s)functions\.metadata(\s|$)"; then
            echo "✅ functions.metadata found in ZIP"
          else
            echo "⚠️  WARNING: functions.metadata not found in ZIP"
          fi
          
          echo "Deploying to Function App: ${{ env.AZURE_FUNCTIONAPP_NAME }}"
          echo "Resource Group: rg-infrastructure-as-code"
          
          # CRITICAL: Remove WEBSITE_RUN_FROM_PACKAGE if it exists (blocks ZIP deployment)
          echo "Checking for WEBSITE_RUN_FROM_PACKAGE setting..."
          RUN_FROM_PACKAGE=$(az functionapp config appsettings list \
            --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
            --resource-group rg-infrastructure-as-code \
            --query "[?name=='WEBSITE_RUN_FROM_PACKAGE'].value" \
            --output tsv 2>/dev/null || echo "")
          
          SETTINGS_REMOVED=false
          
          if [ -n "$RUN_FROM_PACKAGE" ]; then
            echo "⚠️  WEBSITE_RUN_FROM_PACKAGE is set, removing it..."
            az functionapp config appsettings delete \
              --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
              --resource-group rg-infrastructure-as-code \
              --setting-names WEBSITE_RUN_FROM_PACKAGE \
              --output none
            echo "✅ WEBSITE_RUN_FROM_PACKAGE removed"
            SETTINGS_REMOVED=true
          else
            echo "✅ WEBSITE_RUN_FROM_PACKAGE is not set"
          fi
          
          # Also check and remove WEBSITE_USE_ZIP if it exists
          USE_ZIP=$(az functionapp config appsettings list \
            --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
            --resource-group rg-infrastructure-as-code \
            --query "[?name=='WEBSITE_USE_ZIP'].value" \
            --output tsv 2>/dev/null || echo "")
          
          if [ -n "$USE_ZIP" ]; then
            echo "⚠️  WEBSITE_USE_ZIP is set, removing it..."
            az functionapp config appsettings delete \
              --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
              --resource-group rg-infrastructure-as-code \
              --setting-names WEBSITE_USE_ZIP \
              --output none
            echo "✅ WEBSITE_USE_ZIP removed"
            SETTINGS_REMOVED=true
          fi
          
          # If we removed settings, restart the Function App and wait longer
          if [ "$SETTINGS_REMOVED" = true ]; then
            echo "Restarting Function App to ensure settings are propagated..."
            az functionapp restart \
              --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
              --resource-group rg-infrastructure-as-code \
              --output none
            echo "Waiting 30 seconds for Function App to restart and settings to propagate..."
            sleep 30
            
            # Verify settings are actually removed
            echo "Verifying settings are removed..."
            REMAINING_RUN_FROM_PACKAGE=$(az functionapp config appsettings list \
              --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
              --resource-group rg-infrastructure-as-code \
              --query "[?name=='WEBSITE_RUN_FROM_PACKAGE'].value" \
              --output tsv 2>/dev/null || echo "")
            
            if [ -n "$REMAINING_RUN_FROM_PACKAGE" ]; then
              echo "❌ ERROR: WEBSITE_RUN_FROM_PACKAGE is still set after removal!"
              echo "Value: $REMAINING_RUN_FROM_PACKAGE"
              exit 1
            else
              echo "✅ Verified: WEBSITE_RUN_FROM_PACKAGE is not set"
            fi
          fi
          
          # Check Function App status before deployment
          echo "Checking Function App status..."
          az functionapp show \
            --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
            --resource-group rg-infrastructure-as-code \
            --query "{State:state, DefaultHostName:defaultHostName, Kind:kind}" \
            --output table || echo "⚠️  Could not get Function App status"
          
          # Use direct file upload via Azure CLI (bypasses WEBSITE_RUN_FROM_PACKAGE check)
          echo "Starting deployment via Azure CLI (direct upload)..."
          
          # Try using webapp deployment which might handle this better
          DEPLOY_OUTPUT=$(az webapp deployment source config-zip \
            --resource-group rg-infrastructure-as-code \
            --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
            --src "$ZIP_PATH" \
            --timeout 600 \
            --output json 2>&1) || {
            echo "⚠️  webapp deployment failed, trying functionapp deployment..."
            
            # Try functionapp deployment (without slot - Function App doesn't have slots by default)
            DEPLOY_OUTPUT=$(az functionapp deployment source config-zip \
              --resource-group rg-infrastructure-as-code \
              --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
              --src "$ZIP_PATH" \
              --timeout 600 \
              --output json 2>&1) || {
              echo "⚠️  Function App deployment failed, trying Kudu API with longer wait..."
              echo "Azure CLI error:"
              echo "$DEPLOY_OUTPUT"
              
              # Wait additional time for Azure to fully propagate settings removal
              echo "Waiting additional 60 seconds for Azure to fully propagate settings removal..."
              sleep 60
              
              # Try Kudu API with sync deployment (not async)
              echo "Extracting credentials from publish profile for Kudu API..."
              PUBLISH_CREDS=$(az functionapp deployment list-publishing-credentials \
                --resource-group rg-infrastructure-as-code \
                --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
                --query "{username:publishingUserName, password:publishingPassword}" \
                --output json 2>/dev/null || echo "")
              
              if [ -z "$PUBLISH_CREDS" ]; then
                echo "❌ Could not get publishing credentials"
                exit 1
              fi
              
              USERNAME=$(echo "$PUBLISH_CREDS" | jq -r '.username' || echo "")
              PASSWORD=$(echo "$PUBLISH_CREDS" | jq -r '.password' || echo "")
              
              if [ -z "$USERNAME" ] || [ -z "$PASSWORD" ]; then
                echo "❌ Could not extract credentials for Kudu API"
                exit 1
              fi
              
              echo "Deploying via Kudu API (sync mode)..."
              AUTH=$(echo -n "${USERNAME}:${PASSWORD}" | base64 -w 0)
              # Use sync deployment (no isAsync) - this might work better
              KUDU_URL="https://${{ env.AZURE_FUNCTIONAPP_NAME }}.scm.azurewebsites.net/api/zipdeploy"
              
              HTTP_CODE=$(curl -s -o /tmp/kudu-response.txt -w "%{http_code}" \
                -X POST \
                -H "Authorization: Basic ${AUTH}" \
                -H "Content-Type: application/zip" \
                --data-binary @"${ZIP_PATH}" \
                "${KUDU_URL}")
              
              if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
                echo "✅ Deployment successful via Kudu API (HTTP $HTTP_CODE)"
                cat /tmp/kudu-response.txt
                DEPLOY_OUTPUT="Deployed via Kudu API"
              else
                echo "❌ Kudu API deployment also failed (HTTP $HTTP_CODE)"
                cat /tmp/kudu-response.txt
                echo ""
                echo "Trying to get more details about the error..."
                # Try to get deployment logs
                curl -s -H "Authorization: Basic ${AUTH}" \
                  "https://${{ env.AZURE_FUNCTIONAPP_NAME }}.scm.azurewebsites.net/api/deployments" \
                  | jq '.' 2>/dev/null | head -50 || true
                exit 1
              fi
            }
          }
          
          if [ "$DEPLOY_OUTPUT" != "Deployed via Kudu API" ]; then
            echo "✅ Deployment successful via Azure CLI!"
            echo "Deployment output:"
            echo "$DEPLOY_OUTPUT" | jq '.' 2>/dev/null || echo "$DEPLOY_OUTPUT"
          fi
          
          echo "Waiting 90 seconds for deployment to complete and Functions to register..."
          sleep 90
          
          # CRITICAL: Verify files were actually deployed
          echo "Verifying deployment by checking if files exist..."
          PUBLISH_CREDS=$(az functionapp deployment list-publishing-credentials \
            --resource-group rg-infrastructure-as-code \
            --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
            --query "{username:publishingUserName, password:publishingPassword}" \
            --output json 2>/dev/null || echo "")
          
          if [ -n "$PUBLISH_CREDS" ]; then
            USERNAME=$(echo "$PUBLISH_CREDS" | jq -r '.username' || echo "")
            PASSWORD=$(echo "$PUBLISH_CREDS" | jq -r '.password' || echo "")
            
            if [ -n "$USERNAME" ] && [ -n "$PASSWORD" ]; then
              AUTH=$(echo -n "${USERNAME}:${PASSWORD}" | base64 -w 0)
              
              # Check if host.json exists
              HTTP_CODE=$(curl -s -o /tmp/host-check.txt -w "%{http_code}" \
                -H "Authorization: Basic ${AUTH}" \
                "https://${{ env.AZURE_FUNCTIONAPP_NAME }}.scm.azurewebsites.net/api/vfs/site/wwwroot/host.json")
              
              if [ "$HTTP_CODE" = "200" ]; then
                echo "✅ Verified: host.json exists in deployment"
              else
                echo "❌ ERROR: host.json not found after deployment (HTTP $HTTP_CODE)"
                echo "Deployment may have failed silently!"
                exit 1
              fi
              
              # Check if ProcessCsvBlobTrigger.dll exists
              HTTP_CODE=$(curl -s -o /tmp/dll-check.txt -w "%{http_code}" \
                -H "Authorization: Basic ${AUTH}" \
                "https://${{ env.AZURE_FUNCTIONAPP_NAME }}.scm.azurewebsites.net/api/vfs/site/wwwroot/ProcessCsvBlobTrigger.dll")
              
              if [ "$HTTP_CODE" = "200" ]; then
                echo "✅ Verified: ProcessCsvBlobTrigger.dll exists in deployment"
              else
                echo "⚠️  WARNING: ProcessCsvBlobTrigger.dll not found (HTTP $HTTP_CODE)"
                echo "This might be OK if DLLs are in a subdirectory"
              fi
            fi
          fi
          
          # Verify deployment by checking Function App status
          echo "Verifying Function App status..."
          az functionapp show \
            --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
            --resource-group rg-infrastructure-as-code \
            --query "{State:state, DefaultHostName:defaultHostName}" \
            --output table || echo "⚠️  Could not verify Function App status"

      - name: 'Verify deployment'
        shell: bash
        run: |
          echo "Function App deployed successfully!"
          echo "Function App Name: ${{ env.AZURE_FUNCTIONAPP_NAME }}"
          echo "Waiting 30 seconds for Functions to be registered..."
          sleep 30
          echo "Deployment completed at $(date)"
          
      - name: 'List deployed functions'
        shell: bash
        run: |
          echo "Checking deployed functions..."
          az functionapp function list \
            --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
            --resource-group rg-infrastructure-as-code \
            --output table || echo "Functions not yet visible (may take a few minutes)"


