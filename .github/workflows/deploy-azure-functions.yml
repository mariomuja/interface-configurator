name: Deploy Azure Functions

on:
  push:
    branches:
      - main
    paths:
      - 'azure-functions/**'
      - '.github/workflows/deploy-azure-functions.yml'
  workflow_dispatch:

env:
  AZURE_FUNCTIONAPP_NAME: func-appe1mz5h  # Will be updated from Terraform outputs
  AZURE_FUNCTIONAPP_PACKAGE_PATH: 'azure-functions/ProcessCsvBlobTrigger'
  DOTNET_VERSION: '8.0.x'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout GitHub Action'
        uses: actions/checkout@v4

      - name: Setup .NET Core
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: 'Resolve Project Dependencies'
        shell: bash
        run: |
          cd './${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}'
          pwd
          ls -la
          echo "Restoring dependencies..."
          dotnet restore ProcessCsvBlobTrigger.csproj

      - name: 'Build .NET Function App'
        shell: bash
        run: |
          cd './${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}'
          echo "Building project..."
          dotnet build ProcessCsvBlobTrigger.csproj --configuration Release --no-restore

      - name: 'Publish .NET Function App'
        shell: bash
        run: |
          cd './${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}'
          echo "Publishing project..."
          dotnet publish ProcessCsvBlobTrigger.csproj --configuration Release --output ./publish --no-build

      - name: 'Create deployment package'
        shell: bash
        run: |
          cd './${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}/publish'
          # Verify required files exist
          echo "Checking required files..."
          ls -la host.json || echo "ERROR: host.json not found!"
          ls -la functions.metadata || echo "ERROR: functions.metadata not found!"
          ls -la ProcessCsvBlobTrigger.dll || echo "ERROR: ProcessCsvBlobTrigger.dll not found!"
          ls -la ProcessCsvBlobTrigger.Core.dll || echo "WARNING: ProcessCsvBlobTrigger.Core.dll not found (might be OK)"
          ls -la extensions.json || echo "WARNING: extensions.json not found"
          
          # Verify Core assembly is present
          if [ ! -f "ProcessCsvBlobTrigger.dll" ]; then
            echo "❌ ERROR: ProcessCsvBlobTrigger.dll is missing!"
            exit 1
          fi
          
          if [ ! -f "host.json" ]; then
            echo "❌ ERROR: host.json is missing!"
            exit 1
          fi
          
          if [ ! -f "functions.metadata" ]; then
            echo "❌ ERROR: functions.metadata is missing!"
            exit 1
          fi
          
          # Exclude unnecessary files to reduce package size
          echo "Cleaning up unnecessary files..."
          find . -name "Microsoft.CodeAnalysis*.dll" -delete || true
          find . -name "Microsoft.CodeAnalysis*.pdb" -delete || true
          find . -name "*.Designer.dll" -delete || true
          find . -name "*.Designer.pdb" -delete || true
          find . -name "*.xml" -delete || true
          find . -name "*.pdb" -delete || true
          find . -type d -name "runtimes" -exec rm -rf {} + 2>/dev/null || true
          
          # Create ZIP with all files (use absolute path to avoid issues)
          # Important: Create ZIP from current directory (publish folder) with all files
          ZIP_PATH="$(pwd)/../function-app.zip"
          echo "Creating ZIP from: $(pwd)"
          echo "ZIP will be created at: $ZIP_PATH"
          
          # List files before creating ZIP
          echo "Files to be included in ZIP:"
          find . -type f | head -20
          
          # Create ZIP - include all files from current directory
          zip -r "$ZIP_PATH" . -q
          cd ..
          
          echo "Package created at: $ZIP_PATH"
          echo "Package size: $(du -h function-app.zip | cut -f1)"
          echo ""
          echo "Package contents (first 50 files):"
          unzip -l function-app.zip | head -50
          
          # Verify ZIP contains critical files (check exact paths)
          echo ""
          echo "Verifying critical files in ZIP..."
          if unzip -l function-app.zip | grep -qE "(^|\s)host\.json(\s|$)"; then
            echo "✅ host.json found in ZIP"
          else
            echo "❌ ERROR: ZIP does not contain host.json!"
            echo "ZIP contents:"
            unzip -l function-app.zip | grep -i "host\|json" || true
            exit 1
          fi
          
          if unzip -l function-app.zip | grep -qE "(^|\s)functions\.metadata(\s|$)"; then
            echo "✅ functions.metadata found in ZIP"
          else
            echo "❌ ERROR: ZIP does not contain functions.metadata!"
            exit 1
          fi
          
          if unzip -l function-app.zip | grep -q "ProcessCsvBlobTrigger.dll"; then
            echo "✅ ProcessCsvBlobTrigger.dll found in ZIP"
          else
            echo "❌ ERROR: ZIP does not contain ProcessCsvBlobTrigger.dll!"
            echo "DLL files in ZIP:"
            unzip -l function-app.zip | grep "\.dll" | head -10 || true
            exit 1
          fi
          
          echo "✅ ZIP package verified successfully"

      - name: 'Azure Login'
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: 'Deploy to Azure Functions via Azure CLI'
        shell: bash
        run: |
          set -eo pipefail
          echo "Deploying ZIP package via Azure CLI..."
          
          ZIP_PATH="${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}/function-app.zip"
          
          # Verify ZIP file exists
          if [ ! -f "$ZIP_PATH" ]; then
            echo "❌ ERROR: ZIP file not found at $ZIP_PATH"
            exit 1
          fi
          
          echo "ZIP file size: $(du -h "$ZIP_PATH" | cut -f1)"
          echo "Deploying to Function App: ${{ env.AZURE_FUNCTIONAPP_NAME }}"
          echo "Resource Group: rg-infrastructure-as-code"
          
          # Use Azure CLI for deployment
          # Azure CLI handles the upload and deployment automatically
          az functionapp deployment source config-zip \
            --resource-group rg-infrastructure-as-code \
            --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
            --src "$ZIP_PATH" \
            --timeout 600 \
            --output table
          
          if [ $? -eq 0 ]; then
            echo "✅ Deployment successful!"
            echo "Waiting 90 seconds for deployment to complete and Functions to register..."
            sleep 90
            
            # Verify deployment by checking Function App status
            echo "Verifying Function App status..."
            az functionapp show \
              --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
              --resource-group rg-infrastructure-as-code \
              --query "{State:state, DefaultHostName:defaultHostName}" \
              --output table || echo "⚠️  Could not verify Function App status"
          else
            echo "❌ Deployment failed"
            exit 1
          fi

      - name: 'Verify deployment'
        shell: bash
        run: |
          echo "Function App deployed successfully!"
          echo "Function App Name: ${{ env.AZURE_FUNCTIONAPP_NAME }}"
          echo "Waiting 30 seconds for Functions to be registered..."
          sleep 30
          echo "Deployment completed at $(date)"
          
      - name: 'List deployed functions'
        shell: bash
        run: |
          echo "Checking deployed functions..."
          az functionapp function list \
            --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
            --resource-group rg-infrastructure-as-code \
            --output table || echo "Functions not yet visible (may take a few minutes)"


