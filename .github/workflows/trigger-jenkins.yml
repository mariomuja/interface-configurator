name: Trigger Jenkins Build

on:
  push:
    branches:
      - 'ready/**'
      - 'main'
  workflow_dispatch:

jobs:
  trigger-jenkins:
    runs-on: ubuntu-latest
    steps:
      - name: Check Jenkins Configuration
        id: check_config
        run: |
          if [ -z "${{ secrets.JENKINS_URL }}" ]; then
            echo "⚠️  Jenkins secrets not configured. Skipping Jenkins trigger."
            echo ""
            echo "To enable Jenkins triggering, configure these GitHub secrets:"
            echo "  - JENKINS_URL (e.g., http://localhost:8080)"
            echo "  - JENKINS_USER (e.g., admin)"
            echo "  - JENKINS_TOKEN (API token from Jenkins)"
            echo ""
            echo "See .github/workflows/JENKINS_TRIGGER_SETUP.md for details"
            echo "configured=false" >> $GITHUB_OUTPUT
          else
            echo "✅ Jenkins secrets configured"
            echo "configured=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Trigger Jenkins Build
        if: steps.check_config.outputs.configured == 'true'
        run: |
          echo "Triggering Jenkins build for branch: ${{ github.ref_name }}"
          
          # Jenkins URL and job path
          JENKINS_URL="${{ secrets.JENKINS_URL }}"
          JENKINS_USER="${{ secrets.JENKINS_USER }}"
          JENKINS_TOKEN="${{ secrets.JENKINS_TOKEN }}"
          
          # Option 1: Trigger via generic webhook (if installed)
          # Uncomment if you have Generic Webhook Trigger plugin installed
          # curl -X POST "${JENKINS_URL}/generic-webhook-trigger/invoke" \
          #   -H "Content-Type: application/json" \
          #   -d '{"ref": "${{ github.ref }}", "repository": "${{ github.repository }}"}'
          
          # Option 2: Trigger via crumbIssuer + build API (requires auth)
          echo "Getting Jenkins crumb..."
          CRUMB=$(curl -s -u "${JENKINS_USER}:${JENKINS_TOKEN}" \
            "${JENKINS_URL}/crumbIssuer/api/json" | jq -r '.crumb')
          
          if [ -z "$CRUMB" ] || [ "$CRUMB" = "null" ]; then
            echo "⚠️  Could not get Jenkins crumb. Jenkins might not require CSRF protection."
            echo "Triggering build without crumb..."
            curl -X POST -u "${JENKINS_USER}:${JENKINS_TOKEN}" \
              "${JENKINS_URL}/job/interface-configurator/build?delay=0sec"
          else
            echo "Triggering build with crumb..."
            curl -X POST -u "${JENKINS_USER}:${JENKINS_TOKEN}" \
              -H "Jenkins-Crumb: ${CRUMB}" \
              "${JENKINS_URL}/job/interface-configurator/build?delay=0sec"
          fi
          
          echo "✅ Jenkins build triggered successfully"

      - name: Notify
        if: steps.check_config.outputs.configured == 'true'
        run: |
          echo "Jenkins should now build branch: ${{ github.ref_name }}"
          echo "Check Jenkins at: ${{ secrets.JENKINS_URL }}"

