name: Sync Ready Branches to GitLab

on:
  push:
    branches:
      - 'ready/**'
  workflow_dispatch:
    inputs:
      branch_name:
        description: 'Branch name to sync (e.g., ready/test-pipeline-deployment)'
        required: true
        type: string

jobs:
  sync-branch-to-gitlab:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history to get commit SHA

      - name: Determine branch name
        id: branch
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            BRANCH_NAME="${{ github.event.inputs.branch_name }}"
          else
            BRANCH_NAME="${{ github.ref_name }}"
          fi
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "Syncing branch: $BRANCH_NAME"

      - name: Get latest commit SHA
        id: commit
        run: |
          COMMIT_SHA=$(git rev-parse HEAD)
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "Commit SHA: $COMMIT_SHA"

      - name: Sync branch to GitLab
        env:
          GITLAB_TOKEN: ${{ secrets.gitlab_token }}
          GITLAB_PROJECT_ID: ${{ secrets.GITLAB_PROJECT_ID || 'mariomuja/interface-configurator' }}
        run: |
          BRANCH_NAME="${{ steps.branch.outputs.branch_name }}"
          COMMIT_SHA="${{ steps.commit.outputs.commit_sha }}"
          PROJECT_PATH=$(echo "$GITLAB_PROJECT_ID" | sed 's/\//%2F/g')
          BRANCH_PATH=$(echo "$BRANCH_NAME" | sed 's/\//%2F/g')
          
          echo "Syncing branch '$BRANCH_NAME' (commit: $COMMIT_SHA) to GitLab..."
          
          # Check if branch exists in GitLab
          CHECK_RESPONSE=$(curl -s -w "\n%{http_code}" -X GET \
            --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
            "https://gitlab.com/api/v4/projects/$PROJECT_PATH/repository/branches/$BRANCH_PATH")
          
          CHECK_HTTP_CODE=$(echo "$CHECK_RESPONSE" | tail -n1)
          
          if [ "$CHECK_HTTP_CODE" != "200" ]; then
            # Create branch using main as base (GitLab API requires ref to be an existing branch)
            echo "Creating branch based on main..."
            RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
              --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
              --header "Content-Type: application/json" \
              --data "{\"branch\":\"$BRANCH_NAME\",\"ref\":\"main\"}" \
              "https://gitlab.com/api/v4/projects/$PROJECT_PATH/repository/branches")
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')
            
            if [ "$HTTP_CODE" != "201" ] && [ "$HTTP_CODE" != "400" ]; then
              echo "❌ Error creating branch (HTTP $HTTP_CODE): $BODY"
              exit 1
            fi
          fi
          
          echo "✅ Branch exists in GitLab"
          echo "Pushing all files to GitLab branch using git..."
          
          # Get GitLab repository URL - use project ID format
          # GitLab API uses project ID or path, for git we need the full path
          GITLAB_REPO_URL="https://oauth2:${GITLAB_TOKEN}@gitlab.com/${GITLAB_PROJECT_ID}.git"
          
          echo "GitLab repo URL: https://oauth2:***@gitlab.com/${GITLAB_PROJECT_ID}.git"
          
          # Configure git
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # Show current branch and commits
          echo "Current branch: $(git branch --show-current)"
          echo "Latest commit: $(git rev-parse HEAD)"
          echo "Files in current commit:"
          git ls-tree -r HEAD --name-only | head -20
          
          # Add GitLab remote temporarily
          git remote add gitlab "$GITLAB_REPO_URL" 2>/dev/null || git remote set-url gitlab "$GITLAB_REPO_URL"
          
          # Fetch from GitLab to see what's there
          echo "Fetching from GitLab..."
          git fetch gitlab "$BRANCH_NAME" 2>&1 || echo "Branch doesn't exist in GitLab yet (expected)"
          
          # Push the branch to GitLab (force push to overwrite)
          echo "Pushing branch '$BRANCH_NAME' to GitLab..."
          echo "Using command: git push gitlab HEAD:$BRANCH_NAME --force"
          
          # Capture both stdout and stderr
          set +e  # Don't exit on error
          git push gitlab "HEAD:$BRANCH_NAME" --force -v 2>&1 | tee /tmp/git_push_output.txt
          PUSH_EXIT_CODE=${PIPESTATUS[0]}
          set -e  # Re-enable exit on error
          
          PUSH_OUTPUT=$(cat /tmp/git_push_output.txt)
          echo ""
          echo "=== Git Push Output ==="
          echo "$PUSH_OUTPUT"
          echo "=== End Git Push Output ==="
          echo ""
          echo "Exit code: $PUSH_EXIT_CODE"
          
          if [ $PUSH_EXIT_CODE -eq 0 ]; then
            echo "✅ Entire branch pushed to GitLab successfully"
            echo "SKIP_FILE_PUSH=true" >> $GITHUB_ENV
            
            # Verify the push worked by checking if files exist
            echo "Verifying push by checking file count..."
            sleep 3
            FILES_RESPONSE=$(curl -s -X GET \
              --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
              "https://gitlab.com/api/v4/projects/$PROJECT_PATH/repository/tree?ref=$BRANCH_NAME&recursive=true&per_page=100")
            FILE_COUNT=$(echo "$FILES_RESPONSE" | grep -o '"name"' | wc -l || echo "0")
            echo "Files found in GitLab branch: $FILE_COUNT"
            
            if [ "$FILE_COUNT" -lt "10" ]; then
              echo "⚠️  Warning: Very few files found. Push may not have worked correctly."
              echo "SKIP_FILE_PUSH=false" >> $GITHUB_ENV
            fi
          else
            echo "❌ Git push failed with exit code $PUSH_EXIT_CODE"
            echo ""
            echo "Common causes:"
            echo "  1. Token doesn't have 'write_repository' scope"
            echo "  2. Branch is protected in GitLab"
            echo "  3. Force push is not allowed"
            echo ""
            echo "Will try API method for .gitlab-ci.yml only"
            echo "SKIP_FILE_PUSH=false" >> $GITHUB_ENV
          fi
          
          # Remove the temporary remote
          git remote remove gitlab

      - name: Push .gitlab-ci.yml to GitLab branch (fallback)
        if: env.SKIP_FILE_PUSH != 'true'
        env:
          GITLAB_TOKEN: ${{ secrets.gitlab_token }}
          GITLAB_PROJECT_ID: ${{ secrets.GITLAB_PROJECT_ID || 'mariomuja/interface-configurator' }}
          SKIP_FILE_PUSH: ${{ env.SKIP_FILE_PUSH }}
        run: |
          BRANCH_NAME="${{ steps.branch.outputs.branch_name }}"
          PROJECT_PATH=$(echo "$GITLAB_PROJECT_ID" | sed 's/\//%2F/g')
          
          echo "Using API fallback method to push .gitlab-ci.yml..."
          
          # Clean the file: remove BOM, ensure Unix line endings, remove control characters
          # Remove carriage returns, null bytes, and other control characters
          sed 's/\r$//' .gitlab-ci.yml | sed 's/\x00//g' | sed 's/[\x01-\x08\x0B-\x0C\x0E-\x1F\x7F]//g' | sed '1s/^\xEF\xBB\xBF//' > .gitlab-ci.yml.clean
          
          # Verify the cleaned file starts correctly (should start with # for YAML comment)
          FIRST_CHAR=$(head -c 1 .gitlab-ci.yml.clean | od -An -tx1 | tr -d ' \n')
          if [ "$FIRST_CHAR" != "23" ]; then
            echo "⚠️  Warning: File may have encoding issues (first byte: $FIRST_CHAR)"
          fi
          
          # Get the cleaned content and encode it properly
          CI_CONTENT=$(base64 -w 0 < .gitlab-ci.yml.clean)
          
          echo "Creating commit with .gitlab-ci.yml file..."
          
          # First, try to delete existing file if it exists (to avoid control character issues)
          echo "Checking if file exists and deleting if present..."
          DELETE_RESPONSE=$(curl -s -w "\n%{http_code}" -X DELETE \
            --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
            "https://gitlab.com/api/v4/projects/$PROJECT_PATH/repository/files/.gitlab-ci.yml?ref=$BRANCH_NAME" 2>/dev/null || echo -e "\n404")
          
          # Now create the file fresh
          # Use jq for proper JSON construction if available
          if command -v jq &> /dev/null; then
            JSON_PAYLOAD=$(jq -n \
              --arg branch "$BRANCH_NAME" \
              --arg content "$CI_CONTENT" \
              '{branch: $branch, commit_message: "Add/Update .gitlab-ci.yml from ready branch", actions: [{action: "create", file_path: ".gitlab-ci.yml", content: $content, encoding: "base64"}]}')
          else
            # For printf, we need to be careful with escaping - base64 shouldn't need escaping but be safe
            JSON_PAYLOAD=$(printf '{"branch":"%s","commit_message":"Add/Update .gitlab-ci.yml from ready branch","actions":[{"action":"create","file_path":".gitlab-ci.yml","content":"%s","encoding":"base64"}]}' "$BRANCH_NAME" "$CI_CONTENT")
          fi
          
          # Create a commit that adds .gitlab-ci.yml
          COMMIT_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
            --header "Content-Type: application/json" \
            --data "$JSON_PAYLOAD" \
            "https://gitlab.com/api/v4/projects/$PROJECT_PATH/repository/commits")
          
          COMMIT_HTTP_CODE=$(echo "$COMMIT_RESPONSE" | tail -n1)
          COMMIT_BODY=$(echo "$COMMIT_RESPONSE" | sed '$d')
          
          if [ "$COMMIT_HTTP_CODE" = "201" ]; then
            echo "✅ .gitlab-ci.yml file pushed to GitLab branch"
          else
            echo "⚠️  Could not push .gitlab-ci.yml (HTTP $COMMIT_HTTP_CODE): $COMMIT_BODY"
            # Don't fail - the branch exists and push mirror may sync it
          fi

      - name: Wait for branch to be ready
        run: |
          echo "Waiting a few seconds for GitLab to process the branch..."
          sleep 5

      - name: Trigger GitLab Pipeline
        env:
          GITLAB_TOKEN: ${{ secrets.gitlab_token }}
          GITLAB_PROJECT_ID: ${{ secrets.GITLAB_PROJECT_ID || 'mariomuja/interface-configurator' }}
        run: |
          BRANCH_NAME="${{ steps.branch.outputs.branch_name }}"
          PROJECT_PATH=$(echo "$GITLAB_PROJECT_ID" | sed 's/\//%2F/g')
          
          echo "Triggering pipeline for branch '$BRANCH_NAME' in GitLab..."
          
          # Try to trigger pipeline
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
            --header "Content-Type: application/json" \
            --data "{\"ref\":\"$BRANCH_NAME\"}" \
            "https://gitlab.com/api/v4/projects/$PROJECT_PATH/pipeline")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" = "201" ]; then
            PIPELINE_ID=$(echo "$BODY" | grep -o '"id":[0-9]*' | head -1 | cut -d':' -f2)
            echo "✅ Pipeline triggered successfully!"
            echo "Pipeline ID: $PIPELINE_ID"
            echo "View pipeline: https://gitlab.com/$GITLAB_PROJECT_ID/-/pipelines/$PIPELINE_ID"
          elif [ "$HTTP_CODE" = "400" ] && echo "$BODY" | grep -q "Missing CI config file"; then
            echo "⚠️  Pipeline cannot be triggered: Missing CI config file"
            echo "This usually means:"
            echo "  1. The branch doesn't have .gitlab-ci.yml yet (will be synced by push mirror)"
            echo "  2. Or the file path is incorrect"
            echo ""
            echo "The branch exists in GitLab. Once the push mirror syncs the commits,"
            echo "you can manually trigger the pipeline in GitLab UI:"
            echo "  https://gitlab.com/$GITLAB_PROJECT_ID/-/pipelines/new"
            echo ""
            echo "Or wait for the push mirror to sync, then pipelines will appear automatically."
          else
            echo "⚠️  Could not trigger pipeline (HTTP $HTTP_CODE): $BODY"
            echo ""
            echo "The branch exists in GitLab. You can manually trigger the pipeline:"
            echo "  https://gitlab.com/$GITLAB_PROJECT_ID/-/pipelines/new"
            echo "  Select branch: $BRANCH_NAME"
          fi

      - name: Summary
        run: |
          echo "## ✅ Branch Sync Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`${{ steps.branch.outputs.branch_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ steps.commit.outputs.commit_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **GitLab Project**: \`${{ secrets.GITLAB_PROJECT_ID || 'mariomuja/interface-configurator' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View branch in GitLab: https://gitlab.com/${{ secrets.GITLAB_PROJECT_ID || 'mariomuja/interface-configurator' }}/-/tree/${{ steps.branch.outputs.branch_name }}" >> $GITHUB_STEP_SUMMARY

