name: Sync Ready Branches to GitLab

on:
  push:
    branches:
      - 'ready/**'
  workflow_dispatch:
    inputs:
      branch_name:
        description: 'Branch name to sync (e.g., ready/test-pipeline-deployment)'
        required: true
        type: string

jobs:
  sync-branch-to-gitlab:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history to get commit SHA

      - name: Determine branch name
        id: branch
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            BRANCH_NAME="${{ github.event.inputs.branch_name }}"
          else
            BRANCH_NAME="${{ github.ref_name }}"
          fi
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "Syncing branch: $BRANCH_NAME"

      - name: Get latest commit SHA
        id: commit
        run: |
          COMMIT_SHA=$(git rev-parse HEAD)
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "Commit SHA: $COMMIT_SHA"

      - name: Sync branch to GitLab
        env:
          GITLAB_TOKEN: ${{ secrets.gitlab_token }}
          GITLAB_PROJECT_ID: ${{ secrets.GITLAB_PROJECT_ID || 'mariomuja/interface-configurator' }}
        run: |
          BRANCH_NAME="${{ steps.branch.outputs.branch_name }}"
          COMMIT_SHA="${{ steps.commit.outputs.commit_sha }}"
          PROJECT_PATH=$(echo "$GITLAB_PROJECT_ID" | sed 's/\//%2F/g')
          BRANCH_PATH=$(echo "$BRANCH_NAME" | sed 's/\//%2F/g')
          
          echo "Syncing branch '$BRANCH_NAME' (commit: $COMMIT_SHA) to GitLab..."
          
          # Check if branch exists in GitLab
          CHECK_RESPONSE=$(curl -s -w "\n%{http_code}" -X GET \
            --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
            "https://gitlab.com/api/v4/projects/$PROJECT_PATH/repository/branches/$BRANCH_PATH")
          
          CHECK_HTTP_CODE=$(echo "$CHECK_RESPONSE" | tail -n1)
          
          if [ "$CHECK_HTTP_CODE" != "200" ]; then
            # Create branch using main as base (GitLab API requires ref to be an existing branch)
            echo "Creating branch based on main..."
            RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
              --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
              --header "Content-Type: application/json" \
              --data "{\"branch\":\"$BRANCH_NAME\",\"ref\":\"main\"}" \
              "https://gitlab.com/api/v4/projects/$PROJECT_PATH/repository/branches")
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')
            
            if [ "$HTTP_CODE" != "201" ] && [ "$HTTP_CODE" != "400" ]; then
              echo "❌ Error creating branch (HTTP $HTTP_CODE): $BODY"
              exit 1
            fi
          fi
          
          echo "✅ Branch exists in GitLab"
          echo "Pushing .gitlab-ci.yml file to branch..."

      - name: Push .gitlab-ci.yml to GitLab branch
        env:
          GITLAB_TOKEN: ${{ secrets.gitlab_token }}
          GITLAB_PROJECT_ID: ${{ secrets.GITLAB_PROJECT_ID || 'mariomuja/interface-configurator' }}
        run: |
          BRANCH_NAME="${{ steps.branch.outputs.branch_name }}"
          PROJECT_PATH=$(echo "$GITLAB_PROJECT_ID" | sed 's/\//%2F/g')
          
          # Clean the file: remove BOM, ensure Unix line endings, remove control characters
          cat .gitlab-ci.yml | sed 's/\r$//' | sed 's/\x00//g' | sed 's/[\x01-\x08\x0B-\x0C\x0E-\x1F\x7F]//g' > .gitlab-ci.yml.clean
          
          # Get the cleaned content and encode it properly
          CI_CONTENT=$(cat .gitlab-ci.yml.clean | base64 -w 0)
          
          echo "Creating commit with .gitlab-ci.yml file..."
          
          # Create JSON payload - escape the base64 string properly for JSON
          # Use jq if available, otherwise use printf with proper escaping
          if command -v jq &> /dev/null; then
            JSON_PAYLOAD=$(jq -n \
              --arg branch "$BRANCH_NAME" \
              --arg content "$CI_CONTENT" \
              '{branch: $branch, commit_message: "Add .gitlab-ci.yml from ready branch", actions: [{action: "create", file_path: ".gitlab-ci.yml", content: $content, encoding: "base64"}]}')
          else
            # Escape the base64 content for JSON (escape backslashes and quotes)
            ESCAPED_CONTENT=$(echo "$CI_CONTENT" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g')
            JSON_PAYLOAD=$(printf '{"branch":"%s","commit_message":"Add .gitlab-ci.yml from ready branch","actions":[{"action":"create","file_path":".gitlab-ci.yml","content":"%s","encoding":"base64"}]}' "$BRANCH_NAME" "$ESCAPED_CONTENT")
          fi
          
          # Create a commit that adds/updates .gitlab-ci.yml
          COMMIT_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
            --header "Content-Type: application/json" \
            --data "$JSON_PAYLOAD" \
            "https://gitlab.com/api/v4/projects/$PROJECT_PATH/repository/commits")
          
          COMMIT_HTTP_CODE=$(echo "$COMMIT_RESPONSE" | tail -n1)
          COMMIT_BODY=$(echo "$COMMIT_RESPONSE" | sed '$d')
          
          if [ "$COMMIT_HTTP_CODE" = "201" ]; then
            echo "✅ .gitlab-ci.yml file pushed to GitLab branch"
          elif [ "$COMMIT_HTTP_CODE" = "400" ]; then
            if echo "$COMMIT_BODY" | grep -q "already exists"; then
              echo "File exists, updating..."
              # Update existing file - use same cleaned content
              if command -v jq &> /dev/null; then
                UPDATE_JSON=$(jq -n \
                  --arg branch "$BRANCH_NAME" \
                  --arg content "$CI_CONTENT" \
                  '{branch: $branch, commit_message: "Update .gitlab-ci.yml from ready branch", actions: [{action: "update", file_path: ".gitlab-ci.yml", content: $content, encoding: "base64"}]}')
              else
                ESCAPED_CONTENT=$(echo "$CI_CONTENT" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g')
                UPDATE_JSON=$(printf '{"branch":"%s","commit_message":"Update .gitlab-ci.yml from ready branch","actions":[{"action":"update","file_path":".gitlab-ci.yml","content":"%s","encoding":"base64"}]}' "$BRANCH_NAME" "$ESCAPED_CONTENT")
              fi
              
              UPDATE_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
                --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
                --header "Content-Type: application/json" \
                --data "$UPDATE_JSON" \
                "https://gitlab.com/api/v4/projects/$PROJECT_PATH/repository/commits")
              
              UPDATE_HTTP_CODE=$(echo "$UPDATE_RESPONSE" | tail -n1)
              UPDATE_BODY=$(echo "$UPDATE_RESPONSE" | sed '$d')
              if [ "$UPDATE_HTTP_CODE" = "201" ]; then
                echo "✅ .gitlab-ci.yml file updated in GitLab branch"
              else
                echo "⚠️  Could not update file (HTTP $UPDATE_HTTP_CODE): $UPDATE_BODY"
              fi
            else
              echo "⚠️  Error pushing .gitlab-ci.yml (HTTP $COMMIT_HTTP_CODE): $COMMIT_BODY"
            fi
          else
            echo "⚠️  Could not push .gitlab-ci.yml (HTTP $COMMIT_HTTP_CODE): $COMMIT_BODY"
          fi

      - name: Wait for branch to be ready
        run: |
          echo "Waiting a few seconds for GitLab to process the branch..."
          sleep 5

      - name: Trigger GitLab Pipeline
        env:
          GITLAB_TOKEN: ${{ secrets.gitlab_token }}
          GITLAB_PROJECT_ID: ${{ secrets.GITLAB_PROJECT_ID || 'mariomuja/interface-configurator' }}
        run: |
          BRANCH_NAME="${{ steps.branch.outputs.branch_name }}"
          PROJECT_PATH=$(echo "$GITLAB_PROJECT_ID" | sed 's/\//%2F/g')
          
          echo "Triggering pipeline for branch '$BRANCH_NAME' in GitLab..."
          
          # Try to trigger pipeline
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
            --header "Content-Type: application/json" \
            --data "{\"ref\":\"$BRANCH_NAME\"}" \
            "https://gitlab.com/api/v4/projects/$PROJECT_PATH/pipeline")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" = "201" ]; then
            PIPELINE_ID=$(echo "$BODY" | grep -o '"id":[0-9]*' | head -1 | cut -d':' -f2)
            echo "✅ Pipeline triggered successfully!"
            echo "Pipeline ID: $PIPELINE_ID"
            echo "View pipeline: https://gitlab.com/$GITLAB_PROJECT_ID/-/pipelines/$PIPELINE_ID"
          elif [ "$HTTP_CODE" = "400" ] && echo "$BODY" | grep -q "Missing CI config file"; then
            echo "⚠️  Pipeline cannot be triggered: Missing CI config file"
            echo "This usually means:"
            echo "  1. The branch doesn't have .gitlab-ci.yml yet (will be synced by push mirror)"
            echo "  2. Or the file path is incorrect"
            echo ""
            echo "The branch exists in GitLab. Once the push mirror syncs the commits,"
            echo "you can manually trigger the pipeline in GitLab UI:"
            echo "  https://gitlab.com/$GITLAB_PROJECT_ID/-/pipelines/new"
            echo ""
            echo "Or wait for the push mirror to sync, then pipelines will appear automatically."
          else
            echo "⚠️  Could not trigger pipeline (HTTP $HTTP_CODE): $BODY"
            echo ""
            echo "The branch exists in GitLab. You can manually trigger the pipeline:"
            echo "  https://gitlab.com/$GITLAB_PROJECT_ID/-/pipelines/new"
            echo "  Select branch: $BRANCH_NAME"
          fi

      - name: Summary
        run: |
          echo "## ✅ Branch Sync Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`${{ steps.branch.outputs.branch_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ steps.commit.outputs.commit_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **GitLab Project**: \`${{ secrets.GITLAB_PROJECT_ID || 'mariomuja/interface-configurator' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View branch in GitLab: https://gitlab.com/${{ secrets.GITLAB_PROJECT_ID || 'mariomuja/interface-configurator' }}/-/tree/${{ steps.branch.outputs.branch_name }}" >> $GITHUB_STEP_SUMMARY

