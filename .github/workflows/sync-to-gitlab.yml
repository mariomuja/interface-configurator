name: Sync Ready Branches to GitLab

on:
  push:
    branches:
      - 'ready/**'
  workflow_dispatch:
    inputs:
      branch_name:
        description: 'Branch name to sync (e.g., ready/test-pipeline-deployment)'
        required: true
        type: string

jobs:
  sync-branch-to-gitlab:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history to get commit SHA

      - name: Determine branch name
        id: branch
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            BRANCH_NAME="${{ github.event.inputs.branch_name }}"
          else
            BRANCH_NAME="${{ github.ref_name }}"
          fi
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "Syncing branch: $BRANCH_NAME"

      - name: Get latest commit SHA
        id: commit
        run: |
          COMMIT_SHA=$(git rev-parse HEAD)
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "Commit SHA: $COMMIT_SHA"

      - name: Sync branch to GitLab
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          GITLAB_PROJECT_ID: ${{ secrets.GITLAB_PROJECT_ID || 'mariomuja/interface-configurator' }}
        run: |
          BRANCH_NAME="${{ steps.branch.outputs.branch_name }}"
          COMMIT_SHA="${{ steps.commit.outputs.commit_sha }}"
          PROJECT_PATH=$(echo "$GITLAB_PROJECT_ID" | sed 's/\//%2F/g')
          
          echo "Syncing branch '$BRANCH_NAME' (commit: $COMMIT_SHA) to GitLab..."
          
          # Create or update branch in GitLab
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
            --header "Content-Type: application/json" \
            --data "{\"branch\":\"$BRANCH_NAME\",\"ref\":\"$COMMIT_SHA\"}" \
            "https://gitlab.com/api/v4/projects/$PROJECT_PATH/repository/branches")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" = "201" ]; then
            echo "✅ Branch created successfully in GitLab"
          elif [ "$HTTP_CODE" = "400" ] && echo "$BODY" | grep -q "already exists"; then
            echo "Branch already exists, updating..."
            # Update branch by deleting and recreating, or use PUT if available
            # For now, we'll try to trigger pipeline which will work if branch exists
            echo "✅ Branch already exists in GitLab"
          else
            echo "❌ Error syncing branch (HTTP $HTTP_CODE): $BODY"
            exit 1
          fi

      - name: Trigger GitLab Pipeline
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          GITLAB_PROJECT_ID: ${{ secrets.GITLAB_PROJECT_ID || 'mariomuja/interface-configurator' }}
        run: |
          BRANCH_NAME="${{ steps.branch.outputs.branch_name }}"
          PROJECT_PATH=$(echo "$GITLAB_PROJECT_ID" | sed 's/\//%2F/g')
          
          echo "Triggering pipeline for branch '$BRANCH_NAME' in GitLab..."
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
            --header "Content-Type: application/json" \
            --data "{\"ref\":\"$BRANCH_NAME\"}" \
            "https://gitlab.com/api/v4/projects/$PROJECT_PATH/pipeline")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" = "201" ]; then
            PIPELINE_ID=$(echo "$BODY" | grep -o '"id":[0-9]*' | head -1 | cut -d':' -f2)
            echo "✅ Pipeline triggered successfully!"
            echo "Pipeline ID: $PIPELINE_ID"
            echo "View pipeline: https://gitlab.com/$GITLAB_PROJECT_ID/-/pipelines/$PIPELINE_ID"
          else
            echo "⚠️  Could not trigger pipeline (HTTP $HTTP_CODE): $BODY"
            echo "Branch may need to sync first. Check GitLab manually."
            # Don't fail - branch sync is the important part
          fi

      - name: Summary
        run: |
          echo "## ✅ Branch Sync Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`${{ steps.branch.outputs.branch_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ steps.commit.outputs.commit_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **GitLab Project**: \`${{ secrets.GITLAB_PROJECT_ID || 'mariomuja/interface-configurator' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View branch in GitLab: https://gitlab.com/${{ secrets.GITLAB_PROJECT_ID || 'mariomuja/interface-configurator' }}/-/tree/${{ steps.branch.outputs.branch_name }}" >> $GITHUB_STEP_SUMMARY

