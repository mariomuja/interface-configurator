<div class="transport-container">
  <!-- Interface Name Selector - Dropdown with Add/Remove/View JSON -->
  <div class="interface-name-container-top">
    <mat-form-field appearance="outline" class="interface-name-field-wide">
      <mat-label>{{ getTranslation('interface.name') }}</mat-label>
      <mat-select [(ngModel)]="currentInterfaceName" (selectionChange)="onInterfaceSelectionChange($event)" [placeholder]="getTranslation('interface.name')">
        <mat-option *ngFor="let config of interfaceConfigurations" [value]="config.interfaceName">
          {{ config.interfaceName }}
        </mat-option>
      </mat-select>
      <mat-icon matSuffix>list</mat-icon>
    </mat-form-field>
    
    <button mat-icon-button (click)="openAddInterfaceDialog()" matTooltip="Add new interface" class="interface-action-button">
      <mat-icon>add</mat-icon>
    </button>
    
    <button mat-icon-button (click)="removeCurrentInterface()" [disabled]="!currentInterfaceName" matTooltip="Remove selected interface" class="interface-action-button">
      <mat-icon>delete</mat-icon>
    </button>
    
    <button mat-raised-button (click)="showInterfaceJson()" [disabled]="!currentInterfaceName" matTooltip="View interface JSON" class="interface-action-button json-button">
      JSON
    </button>
  </div>
  
  <div class="data-container">
    <!-- Source Card (shown when expanded) -->
    <app-adapter-card
      [adapterType]="'Source'"
      [adapterName]="sourceAdapterName"
      [instanceName]="sourceInstanceName"
      [isEnabled]="sourceIsEnabled"
      [receiveFolder]="sourceReceiveFolder"
      [adapterInstanceGuid]="sourceAdapterInstanceGuid"
      [isRestarting]="isRestartingSource"
      [isLoading]="isLoading"
      [expanded]="sourceCardExpanded"
      [showReceiveFolder]="sourceAdapterName === 'CSV'"
      [csvData]="csvDataText"
      [primaryActionDisabled]="destinationAdapterInstances.length === 0"
      (restart)="restartSourceAdapter()"
      (expandedChange)="sourceCardExpanded = $event"
      (csvDataChange)="onCsvDataChange($event)"
      (enabledChange)="onSourceEnabledChangeFromHeader($event)"
      (settingsClick)="openSourceAdapterSettings()"
      (explorerClick)="openBlobContainerExplorer('Source', sourceAdapterName, sourceInstanceName, sourceAdapterInstanceGuid)">
      <div class="sql-source-info" *ngIf="sourceAdapterName === 'SqlServer' && !isLoading">
        <p>SQL Server Source Adapter</p>
        <p *ngIf="sqlPollingStatement" class="polling-statement">
          <strong>Polling Statement:</strong> {{ sqlPollingStatement }}
        </p>
        <p *ngIf="sqlPollingInterval" class="polling-interval">
          <strong>Polling Interval:</strong> {{ sqlPollingInterval }} seconds
        </p>
      </div>
    </app-adapter-card>

<!-- MessageBox Data Card -->
<mat-expansion-panel [(expanded)]="messageBoxExpanded" class="message-box-card">
  <mat-expansion-panel-header>
    <mat-panel-title>
      <div class="message-box-header">
        <mat-icon class="expand-icon">
          {{ messageBoxExpanded ? 'expand_less' : 'expand_more' }}
        </mat-icon>
        <mat-icon>inbox</mat-icon>
        <div class="message-box-header-text">
          <h3>MessageBox (Source Output)</h3>
        </div>
        <span class="message-count" *ngIf="sourceAdapterInstanceGuid && !isLoadingMessageBox">
          {{ messageBoxTableData.length }} messages
        </span>
      </div>
    </mat-panel-title>
    <mat-panel-description>
      <button mat-icon-button (click)="loadMessageBoxData(); $event.stopPropagation()" [disabled]="isLoadingMessageBox || !sourceAdapterInstanceGuid" matTooltip="Refresh MessageBox data">
        <mat-icon>{{ isLoadingMessageBox ? 'hourglass_empty' : 'refresh' }}</mat-icon>
      </button>
    </mat-panel-description>
  </mat-expansion-panel-header>
  
  <div class="message-box-content">
    <div *ngIf="sourceAdapterInstanceGuid && isLoadingMessageBox" class="spinner-container">
      <mat-spinner></mat-spinner>
    </div>
    <div class="message-box-table" *ngIf="sourceAdapterInstanceGuid && !isLoadingMessageBox && messageBoxTableData.length > 0">
      <table mat-table [dataSource]="messageBoxTableData" class="data-table">
        <ng-container matColumnDef="datetimeCreated">
          <th mat-header-cell *matHeaderCellDef>Timestamp</th>
          <td mat-cell *matCellDef="let row">{{ row.datetimeCreated | date:'short' }}</td>
        </ng-container>

        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let row">{{ row.status }}</td>
        </ng-container>

        <ng-container *ngFor="let column of messageBoxRecordColumns" [matColumnDef]="column">
          <th mat-header-cell *matHeaderCellDef>{{ column }}</th>
          <td mat-cell *matCellDef="let row">{{ getMessageBoxRecordValue(row, column) }}</td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="messageBoxDisplayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: messageBoxDisplayedColumns"></tr>
        <tr class="mat-row" *matNoDataRow>
          <td class="mat-cell" [attr.colspan]="messageBoxDisplayedColumns.length">
            No data
          </td>
        </tr>
      </table>
    </div>
    <div class="table-empty-message" *ngIf="!sourceIsEnabled">
      <p>The source adapter is disabled. Enable the source adapter to start generating messages.</p>
    </div>
    <div class="table-empty-message" *ngIf="sourceIsEnabled && sourceAdapterInstanceGuid && !isLoadingMessageBox && messageBoxTableData.length === 0">
      <p>No messages in MessageBox yet.</p>
    </div>
    <div class="table-empty-message" *ngIf="sourceIsEnabled && !sourceAdapterInstanceGuid">
      <p>Waiting for source adapter instance configuration...</p>
    </div>
  </div>
</mat-expansion-panel>

<!-- Blob Container Explorer Card - REMOVED: Now shown in modal dialog per adapter instance -->
<!--
<mat-card class="blob-container-card">
  <mat-card-header class="blob-container-header-compact">
    <div class="blob-container-header">
      <mat-icon class="header-icon-small">folder</mat-icon>
      <span class="header-title-small">Blob Container Explorer</span>
      <button mat-icon-button 
              (click)="loadBlobContainerFolders()" 
              [disabled]="isLoadingBlobContainer" 
              matTooltip="Refresh"
              class="header-reload-button">
        <mat-icon class="icon-small">{{ isLoadingBlobContainer ? 'hourglass_empty' : 'refresh' }}</mat-icon>
      </button>
      <button mat-icon-button 
              color="warn" 
              (click)="deleteSelectedBlobFiles()" 
              [disabled]="getSelectedBlobFilesCount() === 0 || isDeletingBlobFiles || isLoadingBlobContainer"
              matTooltip="Delete selected"
              *ngIf="getSelectedBlobFilesCount() > 0"
              class="header-delete-button">
        <mat-icon class="icon-small">delete</mat-icon>
      </button>
    </div>
  </mat-card-header>
  <mat-card-content>
    <div *ngIf="isLoadingBlobContainer" class="spinner-container">
      <mat-spinner></mat-spinner>
    </div>
    <div class="blob-container-explorer" *ngIf="!isLoadingBlobContainer">
      <div *ngIf="blobContainerFolders.length === 0" class="table-empty-message">
        <p>No folders found in blob container.</p>
      </div>
      <div *ngFor="let folder of blobContainerFolders" class="folder-section-compact">
        <div class="folder-header-compact">
          <mat-icon class="folder-icon-small">folder</mat-icon>
          <span class="folder-path-compact">{{ folder.path === '/' ? '/ (root)' : folder.path }}</span>
          <span class="folder-file-count-compact">
            {{ folder.files.length }}<span *ngIf="folder.totalFileCount > folder.files.length">/{{ folder.totalFileCount }}</span>
          </span>
        </div>
        <div class="file-list-compact" *ngIf="folder.files.length > 0">
          <div class="file-list-header-compact">
            <div class="file-header-checkbox-compact">
              <mat-checkbox 
                [checked]="areAllFilesInFolderSelected(folder)"
                [indeterminate]="areSomeFilesInFolderSelected(folder)"
                (change)="toggleFolderSelection(folder)"
                (click)="$event.stopPropagation()"
                class="checkbox-small">
              </mat-checkbox>
            </div>
            <div class="file-header-item-compact file-header-name-compact" (click)="onBlobContainerSortChange('name')" [class.sorted]="blobContainerSortBy === 'name'">
              <span class="header-text-small">Name</span>
              <mat-icon *ngIf="blobContainerSortBy === 'name'" class="sort-icon-small">
                {{ blobContainerSortOrder === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
              </mat-icon>
            </div>
            <div class="file-header-item-compact file-header-size-compact" (click)="onBlobContainerSortChange('size')" [class.sorted]="blobContainerSortBy === 'size'">
              <span class="header-text-small">Size</span>
              <mat-icon *ngIf="blobContainerSortBy === 'size'" class="sort-icon-small">
                {{ blobContainerSortOrder === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
              </mat-icon>
            </div>
            <div class="file-header-item-compact file-header-date-compact" (click)="onBlobContainerSortChange('date')" [class.sorted]="blobContainerSortBy === 'date'">
              <span class="header-text-small">Date</span>
              <mat-icon *ngIf="blobContainerSortBy === 'date'" class="sort-icon-small">
                {{ blobContainerSortOrder === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
              </mat-icon>
            </div>
          </div>
          <div *ngFor="let file of folder.files" class="file-item-compact" [class.selected]="isBlobFileSelected(file.fullPath)">
            <mat-checkbox 
              [checked]="isBlobFileSelected(file.fullPath)"
              (change)="toggleBlobFileSelection(file.fullPath)"
              (click)="$event.stopPropagation()"
              class="file-checkbox-compact checkbox-small">
            </mat-checkbox>
            <mat-icon class="file-icon-small">description</mat-icon>
            <span class="file-name-compact">{{ file.name }}</span>
            <span class="file-size-compact">{{ formatFileSize(file.size) }}</span>
            <span class="file-date-compact">{{ file.lastModified | date:'short' }}</span>
          </div>
          <div class="load-more-container-compact" *ngIf="getBlobFolderPagination(folder.path).hasMore">
            <button 
              mat-button 
              color="primary" 
              (click)="loadMoreBlobFiles(folder.path)"
              [disabled]="getBlobFolderPagination(folder.path).isLoadingMore"
              class="load-more-button-compact">
              <mat-icon *ngIf="!getBlobFolderPagination(folder.path).isLoadingMore" class="icon-small">expand_more</mat-icon>
              <mat-icon *ngIf="getBlobFolderPagination(folder.path).isLoadingMore" class="spinning icon-small">hourglass_empty</mat-icon>
              <span class="button-text-small">{{ getBlobFolderPagination(folder.path).isLoadingMore ? 'Loading...' : 'More' }}</span>
            </button>
          </div>
        </div>
        <div class="folder-empty-compact" *ngIf="folder.files.length === 0">
          <p class="empty-text-small">No files</p>
        </div>
      </div>
    </div>
  </mat-card-content>
</mat-card>

    <!-- Destination Adapter Instances (only shown if feature is enabled) -->
    <mat-card class="destinations-container-card" *ngIf="isDestinationAdapterUIEnabled">
      <mat-card-header class="destinations-header">
        <button mat-icon-button (click)="destinationCardExpanded = !destinationCardExpanded" class="toggle-card-button">
          <mat-icon>{{ destinationCardExpanded ? 'expand_less' : 'expand_more' }}</mat-icon>
        </button>
        <div class="destinations-header-actions">
          <button mat-raised-button 
                  color="primary" 
                  (click)="addDestinationAdapter('CSV')" 
                  class="add-destination-button"
                  matTooltip="Add CSV destination adapter">
            <mat-icon>description</mat-icon>
            Add CSV
          </button>
          <button mat-raised-button 
                  color="primary" 
                  (click)="addDestinationAdapter('SqlServer')" 
                  class="add-destination-button"
                  matTooltip="Add SQL Server destination adapter">
            <mat-icon>storage</mat-icon>
            Add SQL Server
          </button>
        </div>
      </mat-card-header>
      
      <mat-card-content>
        <div [hidden]="!destinationCardExpanded">
          <div class="destination-cards" *ngIf="destinationAdapterInstances.length > 0">
            <app-adapter-card
              *ngFor="let instance of destinationAdapterInstances; let i = index"
              [adapterType]="'Destination'"
              [adapterName]="instance.adapterName"
              [instanceName]="instance.instanceName"
              [isEnabled]="instance.isEnabled"
              [adapterInstanceGuid]="instance.adapterInstanceGuid"
              [isRestarting]="false"
              [isLoading]="isLoading"
              [expanded]="getDestinationCardExpanded(instance.adapterInstanceGuid)"
              [showReceiveFolder]="false"
              [isDisabled]="false"
              [primaryActionDisabled]="isDropTableDisabled()"
              (restart)="restartDestinationAdapter()"
              (expandedChange)="setDestinationCardExpanded(instance.adapterInstanceGuid, $event)"
              (enabledChange)="onDestinationInstanceEnabledChange(instance.adapterInstanceGuid, $event)"
              (primaryAction)="dropTable()"
              (settingsClick)="openDestinationInstanceSettings(instance)"
              (explorerClick)="openBlobContainerExplorer('Destination', instance.adapterName, instance.instanceName, instance.adapterInstanceGuid)">
              <div class="destination-card-actions">
                <button mat-icon-button 
                        (click)="removeDestinationAdapter(instance.adapterInstanceGuid, instance.instanceName)"
                        color="warn"
                        class="delete-destination-button"
                        matTooltip="Remove this destination adapter">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
              <div class="table-container" *ngIf="sqlDisplayedColumns.length > 0">
                <table mat-table [dataSource]="sqlData" class="data-table">
                  <ng-container *ngFor="let column of sqlDisplayedColumns" [matColumnDef]="column">
                    <th mat-header-cell *matHeaderCellDef>{{ getColumnDisplayName(column) }}</th>
                    <td mat-cell *matCellDef="let row">
                      <span *ngIf="isDateColumn(column)">
                        {{ getCellValue(row, column) | date:'short' }}
                      </span>
                      <span *ngIf="!isDateColumn(column) && column.toLowerCase() !== 'id' && isNumericColumn(column, sqlData)">
                        {{ getCellValue(row, column) | number:'1.2-2' }}
                      </span>
                      <span *ngIf="!isDateColumn(column) && (!isNumericColumn(column, sqlData) || column.toLowerCase() === 'id')">
                        {{ getCellValue(row, column) }}
                      </span>
                    </td>
                  </ng-container>
                  <tr mat-header-row *matHeaderRowDef="sqlDisplayedColumns"></tr>
                  <tr mat-row *matRowDef="let row; columns: sqlDisplayedColumns"></tr>
                  <tr class="mat-row" *matNoDataRow>
                    <td class="mat-cell" [attr.colspan]="sqlDisplayedColumns.length">
                      {{ getTranslation('no.data.sql') }}
                    </td>
                  </tr>
                </table>
              </div>
              <div class="table-empty-message" *ngIf="sqlDisplayedColumns.length === 0">
                <p>{{ getTranslation('table.empty') }}</p>
              </div>
            </app-adapter-card>
          </div>
          <div class="no-destinations" *ngIf="destinationAdapterInstances.length === 0">
            <mat-icon>info</mat-icon>
            <p>No destination adapters configured yet. Use the buttons above to add CSV or SQL Server destinations.</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

  <mat-card class="log-card">
    <mat-card-header class="log-header">
      <mat-card-title class="log-title">{{ getTranslation('process.log') }} ({{ logDataSource.data.length }} {{ getTranslation('entries') }})</mat-card-title>
      <div class="log-header-actions">
        <mat-form-field appearance="outline" class="component-filter">
          <mat-label>{{ getTranslation('log.filter') }}</mat-label>
          <mat-select [(ngModel)]="selectedComponent" (selectionChange)="onComponentFilterChange()">
            <mat-option value="all">{{ getTranslation('log.filter.all') }}</mat-option>
            <mat-option value="Azure Function">Azure Function</mat-option>
            <mat-option value="Blob Storage">Blob Storage</mat-option>
            <mat-option value="SQL Server">SQL Server</mat-option>
            <mat-option value="Vercel API">Vercel API</mat-option>
          </mat-select>
        </mat-form-field>
        <button mat-raised-button color="accent" (click)="runDiagnostics()" [disabled]="isDiagnosing" class="diagnose-button">
          <mat-icon>bug_report</mat-icon>
          {{ isDiagnosing ? 'Diagnose...' : 'Diagnose' }}
        </button>
        <button mat-raised-button color="warn" (click)="clearLogs()" class="clear-logs-button">
          <mat-icon>delete</mat-icon>
          {{ getTranslation('log.clear') }}
        </button>
      </div>
    </mat-card-header>
    <mat-card-content>
      <!-- Diagnostics Result -->
      <div *ngIf="diagnosticsResult" class="diagnostics-result">
        <h3>Diagnose-Ergebnisse</h3>
        <div class="diagnostics-summary">
          <p><strong>Status:</strong> {{ diagnosticsResult.summary.overall }}</p>
          <p><strong>Erfolgreich:</strong> {{ diagnosticsResult.summary.passed }}/{{ diagnosticsResult.summary.totalChecks }}</p>
        </div>
        <div class="diagnostics-checks">
          <div *ngFor="let check of diagnosticsResult.checks" class="diagnostic-check" [class.ok]="check.status === 'OK'" [class.failed]="check.status === 'FAILED'" [class.error]="check.status === 'ERROR'">
            <mat-icon>{{ check.status === 'OK' ? 'check_circle' : check.status === 'FAILED' ? 'error' : 'warning' }}</mat-icon>
            <div class="check-details">
              <strong>{{ check.name }}</strong>: {{ check.status }}
              <div class="check-details-text">{{ check.details }}</div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="table-container log-table-container">
        <table mat-table [dataSource]="logDataSource" matSort class="log-table resizable-table">
          <ng-container matColumnDef="timestamp">
            <th mat-header-cell *matHeaderCellDef mat-sort-header="timestamp" class="resizable-header">
              <div class="header-content">
                <span>Zeitstempel</span>
                <div class="resize-handle"></div>
              </div>
            </th>
            <td mat-cell *matCellDef="let row" class="resizable-cell">{{ row.timestamp | date:'short' }}</td>
          </ng-container>
          <ng-container matColumnDef="level">
            <th mat-header-cell *matHeaderCellDef mat-sort-header="level" class="resizable-header">
              <div class="header-content">
                <span>Level</span>
                <div class="resize-handle"></div>
              </div>
            </th>
            <td mat-cell *matCellDef="let row" class="resizable-cell">
              <mat-chip [color]="getLevelColor(row.level)">{{ row.level }}</mat-chip>
            </td>
          </ng-container>
          <ng-container matColumnDef="component">
            <th mat-header-cell *matHeaderCellDef mat-sort-header="component" class="resizable-header">
              <div class="header-content">
                <span>Azure-Komponente</span>
                <div class="resize-handle"></div>
              </div>
            </th>
            <td mat-cell *matCellDef="let row" class="resizable-cell">
              <mat-chip>{{ row.component || 'Unknown' }}</mat-chip>
            </td>
          </ng-container>
          <ng-container matColumnDef="message">
            <th mat-header-cell *matHeaderCellDef mat-sort-header="message" class="resizable-header">
              <div class="header-content">
                <span>Nachricht</span>
                <div class="resize-handle"></div>
              </div>
            </th>
            <td mat-cell *matCellDef="let row" class="resizable-cell">{{ row.message }}</td>
          </ng-container>
          <ng-container matColumnDef="details">
            <th mat-header-cell *matHeaderCellDef mat-sort-header="details" class="resizable-header">
              <div class="header-content">
                <span>Details</span>
                <div class="resize-handle"></div>
              </div>
            </th>
            <td mat-cell *matCellDef="let row" class="resizable-cell">
              <div class="log-details-container">
                <div class="log-details-main" *ngIf="row.details && !hasExceptionDetails(row.details)">
                  {{ row.details }}
                </div>
                <div class="log-details-exception" *ngIf="row.details && hasExceptionDetails(row.details)">
                  <div class="exception-summary">{{ getExceptionSummary(row.details) }}</div>
                  <div class="exception-full" [class.expanded]="isExceptionExpanded(row)">
                    <pre>{{ row.details }}</pre>
                  </div>
                  <button mat-button color="primary" class="exception-toggle" (click)="toggleExceptionDetails(row)">
                    {{ isExceptionExpanded(row) ? 'Weniger anzeigen' : 'Vollst√§ndige Details anzeigen' }}
                  </button>
                </div>
                <span *ngIf="!row.details">-</span>
              </div>
            </td>
          </ng-container>
          <tr mat-header-row *matHeaderRowDef="logDisplayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: logDisplayedColumns"></tr>
        </table>
      </div>
    </mat-card-content>
  </mat-card>
</div>


