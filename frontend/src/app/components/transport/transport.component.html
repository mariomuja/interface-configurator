<div class="transport-container">
  <!-- Interface Name Selector - Dropdown with Add/Remove/View JSON -->
  <div class="interface-name-container-top">
    <mat-form-field appearance="outline" class="interface-name-field-wide">
      <mat-label>{{ getTranslation('interface.name') }}</mat-label>
      <mat-select [(ngModel)]="currentInterfaceName" (selectionChange)="onInterfaceSelectionChange($event)">
        <mat-option *ngFor="let config of interfaceConfigurations" [value]="config.interfaceName">
          {{ config.interfaceName }}
        </mat-option>
      </mat-select>
      <mat-icon matSuffix>list</mat-icon>
    </mat-form-field>
    
    <button mat-icon-button (click)="openAddInterfaceDialog()" matTooltip="Add new interface" class="interface-action-button">
      <mat-icon>add</mat-icon>
    </button>
    
    <button mat-icon-button (click)="removeCurrentInterface()" [disabled]="!currentInterfaceName" matTooltip="Remove selected interface" class="interface-action-button">
      <mat-icon>delete</mat-icon>
    </button>
    
    <button mat-icon-button (click)="showInterfaceJson()" [disabled]="!currentInterfaceName" matTooltip="View interface JSON" class="interface-action-button">
      <mat-icon>code</mat-icon>
    </button>
  </div>
  
  <div class="data-container">
    <!-- Source Card Header with Toggle Button (shown when collapsed) -->
    <div class="source-card-header" *ngIf="!sourceCardExpanded">
      <button mat-icon-button (click)="sourceCardExpanded = !sourceCardExpanded" class="toggle-card-button">
        <mat-icon>expand_more</mat-icon>
      </button>
      <span class="card-header-label">Source</span>
    </div>
    
    <!-- Source Card (shown when expanded) -->
    <app-adapter-card
      *ngIf="sourceCardExpanded"
      [adapterType]="'Source'"
      [adapterName]="sourceAdapterName"
      [instanceName]="sourceInstanceName"
      [isEnabled]="sourceIsEnabled"
      [receiveFolder]="sourceReceiveFolder"
      [adapterInstanceGuid]="sourceAdapterInstanceGuid"
      [isRestarting]="isRestartingSource"
      [isLoading]="isLoading"
      [expanded]="sourceCardExpanded"
      [showReceiveFolder]="sourceAdapterName === 'CSV'"
      (restart)="restartSourceAdapter()"
      (expandedChange)="sourceCardExpanded = $event"
      (primaryAction)="startTransport()"
      (settingsClick)="openSourceAdapterSettings()">
      <div class="csv-text-container" *ngIf="!isLoading && sourceAdapterName === 'CSV'">
        <div class="csv-file-actions">
          <input type="file" #fileInput accept=".txt" (change)="onFileSelected($event)" style="display: none;" />
          <button mat-stroked-button type="button" (click)="fileInput.click()" class="open-file-button">
            <mat-icon>folder_open</mat-icon>
            Open File...
          </button>
        </div>
        <div 
          #csvEditor
          class="csv-text csv-editable" 
          contenteditable="true"
          (input)="onCsvTextChange()"
          (blur)="onCsvTextBlur()"
          spellcheck="false"
          [attr.data-placeholder]="'CSV-Daten hier bearbeiten...'"></div>
      </div>
      <div class="sql-source-info" *ngIf="sourceAdapterName === 'SqlServer' && !isLoading">
        <p>SQL Server Source Adapter</p>
        <p *ngIf="sqlPollingStatement" class="polling-statement">
          <strong>Polling Statement:</strong> {{ sqlPollingStatement }}
        </p>
        <p *ngIf="sqlPollingInterval" class="polling-interval">
          <strong>Polling Interval:</strong> {{ sqlPollingInterval }} seconds
        </p>
      </div>
    </app-adapter-card>

    <!-- Destination Adapter Instances -->
    <mat-card class="destinations-container-card">
      <mat-card-header class="destinations-header">
        <button mat-icon-button (click)="destinationCardExpanded = !destinationCardExpanded" class="toggle-card-button">
          <mat-icon>{{ destinationCardExpanded ? 'expand_less' : 'expand_more' }}</mat-icon>
        </button>
        <div class="destinations-header-actions">
          <button mat-raised-button 
                  color="primary" 
                  (click)="addDestinationAdapter('CSV')" 
                  class="add-destination-button"
                  matTooltip="Add CSV destination adapter">
            <mat-icon>description</mat-icon>
            Add CSV
          </button>
          <button mat-raised-button 
                  color="primary" 
                  (click)="addDestinationAdapter('SqlServer')" 
                  class="add-destination-button"
                  matTooltip="Add SQL Server destination adapter">
            <mat-icon>storage</mat-icon>
            Add SQL Server
          </button>
        </div>
      </mat-card-header>
      
      <mat-card-content>
        <div class="destination-cards" *ngIf="destinationAdapterInstances.length > 0 && destinationCardExpanded">
          <app-adapter-card
            *ngFor="let instance of destinationAdapterInstances; let i = index"
            [adapterType]="'Destination'"
            [adapterName]="instance.adapterName"
            [instanceName]="instance.instanceName"
            [isEnabled]="instance.isEnabled"
            [adapterInstanceGuid]="instance.adapterInstanceGuid"
            [isRestarting]="false"
            [isLoading]="isLoading"
            [expanded]="getDestinationCardExpanded(instance.adapterInstanceGuid)"
            [showReceiveFolder]="false"
            [isDisabled]="i > 0"
            [primaryActionDisabled]="isDropTableDisabled()"
            (restart)="restartDestinationAdapter()"
            (expandedChange)="setDestinationCardExpanded(instance.adapterInstanceGuid, $event)"
            (primaryAction)="dropTable()"
            (settingsClick)="openDestinationInstanceSettings(instance)">
            <div class="destination-card-actions">
              <button mat-icon-button 
                      (click)="removeDestinationAdapter(instance.adapterInstanceGuid, instance.instanceName)"
                      color="warn"
                      class="delete-destination-button"
                      matTooltip="Remove this destination adapter">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
      <div class="table-container" *ngIf="sqlDisplayedColumns.length > 0">
        <table mat-table [dataSource]="sqlData" class="data-table">
          <!-- Dynamic columns - rendered based on SQL data structure (matches CSV columns exactly) -->
          <ng-container *ngFor="let column of sqlDisplayedColumns" [matColumnDef]="column">
            <th mat-header-cell *matHeaderCellDef>{{ getColumnDisplayName(column) }}</th>
            <td mat-cell *matCellDef="let row">
              <!-- Special handling for date columns -->
              <span *ngIf="isDateColumn(column)">
                {{ getCellValue(row, column) | date:'short' }}
              </span>
              <!-- Numeric columns (excluding date and id columns) -->
              <span *ngIf="!isDateColumn(column) && column.toLowerCase() !== 'id' && isNumericColumn(column, sqlData)">
                {{ getCellValue(row, column) | number:'1.2-2' }}
              </span>
              <!-- Text/other columns -->
              <span *ngIf="!isDateColumn(column) && (!isNumericColumn(column, sqlData) || column.toLowerCase() === 'id')">
                {{ getCellValue(row, column) }}
              </span>
            </td>
          </ng-container>
          <tr mat-header-row *matHeaderRowDef="sqlDisplayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: sqlDisplayedColumns"></tr>
          <tr class="mat-row" *matNoDataRow>
            <td class="mat-cell" [attr.colspan]="sqlDisplayedColumns.length">
              {{ getTranslation('no.data.sql') }}
            </td>
          </tr>
        </table>
      </div>
      <div class="table-empty-message" *ngIf="sqlDisplayedColumns.length === 0">
        <p>{{ getTranslation('table.empty') }}</p>
      </div>
    </app-adapter-card>
        </div>
      </mat-card-content>
    </mat-card>

  <mat-card class="log-card">
    <mat-card-header class="log-header">
      <mat-card-title class="log-title">{{ getTranslation('process.log') }} ({{ logDataSource.data.length }} {{ getTranslation('entries') }})</mat-card-title>
      <div class="log-header-actions">
        <mat-form-field appearance="outline" class="component-filter">
          <mat-label>{{ getTranslation('log.filter') }}</mat-label>
          <mat-select [(ngModel)]="selectedComponent" (selectionChange)="onComponentFilterChange()">
            <mat-option value="all">{{ getTranslation('log.filter.all') }}</mat-option>
            <mat-option value="Azure Function">Azure Function</mat-option>
            <mat-option value="Blob Storage">Blob Storage</mat-option>
            <mat-option value="SQL Server">SQL Server</mat-option>
            <mat-option value="Vercel API">Vercel API</mat-option>
          </mat-select>
        </mat-form-field>
        <button mat-raised-button color="accent" (click)="runDiagnostics()" [disabled]="isDiagnosing" class="diagnose-button">
          <mat-icon>bug_report</mat-icon>
          {{ isDiagnosing ? 'Diagnose...' : 'Diagnose' }}
        </button>
        <button mat-raised-button color="warn" (click)="clearLogs()" class="clear-logs-button">
          <mat-icon>delete</mat-icon>
          {{ getTranslation('log.clear') }}
        </button>
      </div>
    </mat-card-header>
    <mat-card-content>
      <!-- Diagnostics Result -->
      <div *ngIf="diagnosticsResult" class="diagnostics-result">
        <h3>Diagnose-Ergebnisse</h3>
        <div class="diagnostics-summary">
          <p><strong>Status:</strong> {{ diagnosticsResult.summary.overall }}</p>
          <p><strong>Erfolgreich:</strong> {{ diagnosticsResult.summary.passed }}/{{ diagnosticsResult.summary.totalChecks }}</p>
        </div>
        <div class="diagnostics-checks">
          <div *ngFor="let check of diagnosticsResult.checks" class="diagnostic-check" [class.ok]="check.status === 'OK'" [class.failed]="check.status === 'FAILED'" [class.error]="check.status === 'ERROR'">
            <mat-icon>{{ check.status === 'OK' ? 'check_circle' : check.status === 'FAILED' ? 'error' : 'warning' }}</mat-icon>
            <div class="check-details">
              <strong>{{ check.name }}</strong>: {{ check.status }}
              <div class="check-details-text">{{ check.details }}</div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="table-container log-table-container">
        <table mat-table [dataSource]="logDataSource" matSort class="log-table resizable-table">
          <ng-container matColumnDef="timestamp">
            <th mat-header-cell *matHeaderCellDef mat-sort-header="timestamp" class="resizable-header">
              <div class="header-content">
                <span>Zeitstempel</span>
                <div class="resize-handle"></div>
              </div>
            </th>
            <td mat-cell *matCellDef="let row" class="resizable-cell">{{ row.timestamp | date:'short' }}</td>
          </ng-container>
          <ng-container matColumnDef="level">
            <th mat-header-cell *matHeaderCellDef mat-sort-header="level" class="resizable-header">
              <div class="header-content">
                <span>Level</span>
                <div class="resize-handle"></div>
              </div>
            </th>
            <td mat-cell *matCellDef="let row" class="resizable-cell">
              <mat-chip [color]="getLevelColor(row.level)">{{ row.level }}</mat-chip>
            </td>
          </ng-container>
          <ng-container matColumnDef="component">
            <th mat-header-cell *matHeaderCellDef mat-sort-header="component" class="resizable-header">
              <div class="header-content">
                <span>Azure-Komponente</span>
                <div class="resize-handle"></div>
              </div>
            </th>
            <td mat-cell *matCellDef="let row" class="resizable-cell">
              <mat-chip>{{ row.component || 'Unknown' }}</mat-chip>
            </td>
          </ng-container>
          <ng-container matColumnDef="message">
            <th mat-header-cell *matHeaderCellDef mat-sort-header="message" class="resizable-header">
              <div class="header-content">
                <span>Nachricht</span>
                <div class="resize-handle"></div>
              </div>
            </th>
            <td mat-cell *matCellDef="let row" class="resizable-cell">{{ row.message }}</td>
          </ng-container>
          <ng-container matColumnDef="details">
            <th mat-header-cell *matHeaderCellDef mat-sort-header="details" class="resizable-header">
              <div class="header-content">
                <span>Details</span>
                <div class="resize-handle"></div>
              </div>
            </th>
            <td mat-cell *matCellDef="let row" class="resizable-cell">
              <div class="log-details-container">
                <div class="log-details-main" *ngIf="row.details && !hasExceptionDetails(row.details)">
                  {{ row.details }}
                </div>
                <div class="log-details-exception" *ngIf="row.details && hasExceptionDetails(row.details)">
                  <div class="exception-summary">{{ getExceptionSummary(row.details) }}</div>
                  <div class="exception-full" [class.expanded]="isExceptionExpanded(row)">
                    <pre>{{ row.details }}</pre>
                  </div>
                  <button mat-button color="primary" class="exception-toggle" (click)="toggleExceptionDetails(row)">
                    {{ isExceptionExpanded(row) ? 'Weniger anzeigen' : 'Vollst√§ndige Details anzeigen' }}
                  </button>
                </div>
                <span *ngIf="!row.details">-</span>
              </div>
            </td>
          </ng-container>
          <tr mat-header-row *matHeaderRowDef="logDisplayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: logDisplayedColumns"></tr>
        </table>
      </div>
    </mat-card-content>
  </mat-card>
</div>


