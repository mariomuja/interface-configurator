# Service Bus Infrastructure Configuration

## Overview
Azure Service Bus namespace has been added to both Bicep and Terraform infrastructure configurations. Topics and subscriptions are created dynamically by the application when interfaces and destination adapter instances are configured.

## Bicep Configuration

### Parameters Added
- `serviceBusNamespaceName`: Name for Service Bus namespace (default: `sb-interface-configurator`)
- `serviceBusSku`: SKU for Service Bus namespace - Basic, Standard, or Premium (default: `Standard`)

### Resources Added
1. **Service Bus Namespace** (`Microsoft.ServiceBus/namespaces@2023-01-01-preview`)
   - Creates the Service Bus namespace
   - Configures TLS 1.2 minimum version
   - Enables public network access

2. **Service Bus Authorization Rule** (`Microsoft.ServiceBus/namespaces/authorizationRules@2023-01-01-preview`)
   - Creates `RootManageSharedAccessKey` authorization rule
   - Grants Listen, Manage, and Send rights
   - Used by the application to access Service Bus

### Function App App Settings Added
- `ServiceBusConnectionString`: Connection string for Service Bus (used by ServiceBusService)
- `AZURE_SERVICEBUS_CONNECTION_STRING`: Alternative environment variable name (for compatibility)

### Outputs Added
- `serviceBusNamespaceName`: Name of the Service Bus namespace
- `serviceBusNamespaceConnectionString`: Full connection string (sensitive)

## Terraform Configuration

### Variables Added (`variables.tf`)
- `service_bus_namespace_name`: Name for Service Bus namespace (default: `sb-interface-configurator`)
- `service_bus_sku`: SKU for Service Bus namespace - Basic, Standard, or Premium (default: `Standard`)

### Resources Added (`main.tf`)
1. **Service Bus Namespace** (`azurerm_servicebus_namespace`)
   - Creates the Service Bus namespace
   - Configures TLS 1.2 minimum version

2. **Service Bus Authorization Rule** (`azurerm_servicebus_namespace_authorization_rule`)
   - Creates `RootManageSharedAccessKey` authorization rule
   - Grants Listen, Manage, and Send rights

### Function App App Settings Added
- `ServiceBusConnectionString`: Connection string for Service Bus
- `AZURE_SERVICEBUS_CONNECTION_STRING`: Alternative environment variable name

### Outputs Added (`outputs.tf`)
- `service_bus_namespace_name`: Name of the Service Bus namespace
- `service_bus_namespace_connection_string`: Full connection string (sensitive)

## Dynamic Topic and Subscription Creation

Topics and subscriptions are **NOT** created in infrastructure code. Instead, they are created dynamically by the application:

- **Topics**: Created when interfaces are configured (one topic per interface)
  - Topic name: `interface-{interfaceName}` (lowercase)
  - Created by: `ServiceBusSubscriptionService.EnsureTopicExistsAsync()`

- **Subscriptions**: Created when destination adapter instances are added/enabled
  - Subscription name: `destination-{adapterInstanceGuid}` (lowercase GUID)
  - Created by: `ServiceBusSubscriptionService.CreateSubscriptionAsync()`
  - Deleted when: Destination adapter instance is disabled or removed

## Deployment Steps

1. **Deploy Infrastructure**:
   ```bash
   # Bicep
   az deployment group create --resource-group rg-interface-configurator --template-file bicep/main.bicep
   
   # Terraform
   terraform init
   terraform plan
   terraform apply
   ```

2. **Verify Service Bus Namespace**:
   - Check that namespace is created
   - Verify connection string is set in Function App app settings

3. **Deploy Application**:
   - Application will automatically create topics/subscriptions when interfaces are configured

## Connection String Format

The connection string format is:
```
Endpoint=sb://{namespaceName}.servicebus.windows.net/;SharedAccessKeyName=RootManageSharedAccessKey;SharedAccessKey={primaryKey}
```

This is automatically generated by both Bicep and Terraform from the authorization rule.

## Notes

- Service Bus namespace must be created before Function App deployment
- Topics and subscriptions are managed by application code, not infrastructure
- Connection strings are stored as app settings in Function App
- Service Bus namespace uses Standard SKU by default (supports topics/subscriptions)
- Basic SKU only supports queues, not topics/subscriptions


